---
layout: post
comments: true
date: 2016-03-03 
title: 定时报表邮件通知解决方案探索
categories:  
- Big Data

---

# 背景

1. 同事嚷嚷着要个定时发送报表的功能。
2. 定时任务功能使用频率高，需要时就苦了技术同胞加 `crontab`。
2. 虽然在新系统规划中，但远水解不了近渴。

所以，决定先搞个临时方案解决问题。


# 探索
## ART

同事推荐了使用过的 [ART][1]，所以就先了解了下。ART 是一个轻量级的、跨平台的、基于 Web 的查询工具和报表平台，并且提供多种形式的数据展示，如表格、图形甚至 dashboard，支持定时任务，如定时发送邮件等。

对于我们来说，主要就看中 ART 支持定时任务，可以定时把相关报表发送给相关人。可是，我并不想用，虽然同事说在原公司用得挺爽的：

* 界面太原始，有windows 98 的感觉。而且，页面组织混乱，没有逻辑性，对新手来说，入门门槛高。
* 仅为了一个定时任务，使用一套新的开源系统，维护成本太高，这是我不想用的根本原因。

## 改造 Hue
现在使用 Hue 作为查询平台，那么，就考虑在 Hue 上做二次开发，但是 Hue 是个巨无霸，动起来伤筋动骨。此法备选。

## Zeppelin
>A web-based notebook that enables interactive data analytics. 

>You can make beautiful data-driven, interactive and collaborative documents with SQL, Scala and more.

上面是 [Zeppelin][2] 官网对 Zeppelin 的描述，前段时间玩儿了会儿 Zeppelin，感觉 Zeppelin 就是一神器，不仅支持数据查询、分析、可视化等，还支持 Spark、Hive、Phoenix 等大数据工具和 Markdown、shell等。Zeppelin 可以作为一个集中式的数据管理和分析平台，正是基于此，我们也在考虑把 Zeppelin 正式推出去用用，所以，何不趁机拿 Zeppelin 做个试验呢。

那么，就考虑怎么利用 Zeppelin 来做定时调度并发送邮件。

![zeppelin schedule][3]

注意到 Zeppelin 有定时任务，如上图所示。但是这个功能比较弱，只能定时执行任务，比如定时执行 HiveQL 等，并不会将执行结果发送给用户。但是，既然 Zeppelin 支持 shell，我就能用shell或者python等脚本来做这件事，将HiveQL语句、收件人列表等作为参数传给脚本，脚本执行完查询语句后，封装数据，发邮件给收件人。明确方法后，很快就能搞定这事！

数据取出来了，邮件发了，还有个重要问题，就是**`权限问题`**。在使用 zeppelin 执行 shell 等脚本时，用户是 zeppelin 后台守护进程的启动者。zeppelin 并没有很好的权限管理。我现在采用的是：

* 基于表的权限控制。Hive中哪些表哪些用户可以查询，做了严格限制。这套系统本来就有，就不用造轮子了。
* 基于收件人的权限控制。数据通过邮件的方式发送给收件人，严格限制收件人，这个可以在脚本里处理。


# 总结
1、权限控制不够，仅依赖表的权限管理，没有自身的权限控制。不过目前来说基本够用，因为，如果有了表权限，那么，任何平台都可以看到；没有表权限，任何平台都看不到。

2、Hue 是一个成熟的软件，已经有定时任务方面的插件了，缺少进一步调研。

3、系统可维护性是个大问题，新增一套系统容易，维护一套系统难。

[1]:https://sourceforge.net/p/art/wiki/Home/ "ART"
[2]:http://zeppelin.incubator.apache.org/ "zeppelin"

[3]:http://7sbmb0.com1.z0.glb.clouddn.com/2016-zeppelin_schedule.jpg "Zeppelin_schedule"
